# 闭包

闭包是 JS 中的重要概念，可以让 JS 实现很多高级特性。例如，数据封装、事件处理器、回调函数等场景。通过闭包，可以实现更强大的功能和更灵活的代码设计。

## 定义

闭包指的是一个函数及其周围环境（即词法环境）的组合。

闭包可以让开发者使用内部函数访问外部函数的作用域。闭包随着函数创建的同时而被创建。

## 词法环境

词法环境指的是在代码的特定部分（如函数体内）变量和函数声明存在的环境。它由两个主要部分组成：

1. **环境记录（Environment Record）**：这是存储变量和函数声明的实际位置。环境记录可以是词法环境的一部分，用于保存在当前作用域内声明的变量和函数。
2. **对外部环境的引用**：这是一个指向外部词法环境的链接，使得当前环境能够访问外部作用域中的变量。这个链接是词法嵌套结构的一部分，即一个函数内部的作用域可以访问其外部函数的作用域。

当代码执行时，JavaScript 引擎会根据当前的词法环境来查找变量和函数的定义。这个查找过程从当前的环境记录开始，如果在当前环境中找不到相应的变量或函数，它会沿着外部环境的引用继续向上查找，直到找到相应的定义或达到全局作用域。

词法环境是“词法作用域”（Lexical Scoping）的基础，它意味着函数的作用域是在函数定义时决定的，而不是在函数调用时。这种机制使得闭包（Closure）成为可能，因为即使一个函数已经返回，它仍然能够记住并访问它被创建时的词法环境。

## 核心特性

闭包的核心特性是：函数可以记住它被创建时的词法环境，无论函数在任何作用域内被调用时，都可以访问这个词法环境中的变量。

例如，一个内部函数引用了外部函数的变量时，即使外部函数已经执行完毕，这个变量也不会被垃圾回收，因为内部函数的闭包保留了对这个变量的引用。

## 例子

最简单的闭包，内部函数使用外部变量。

```js
function init() {
  var name = "Mozilla"; // name 是一个被 init 创建的局部变量
  function displayName() {
    // displayName() 是内部函数，一个闭包
    alert(name); // 使用了父函数中声明的变量
  }
  displayName();
}
init();
```

特性体现：外部函数已经执行完毕，但是闭包创建时存储了词法环境中的变量，达到外部函数就算已经结束但仍然可以调用变量的效果。

```js
function makeFunc() {
  var name = "Mozilla";
  function displayName() {
    alert(name);
  }
  return displayName;
}

var myFunc = makeFunc();
myFunc();
```

## 闭包使用的场景

闭包真正值得关注的地方是定义函数与调用函数的作用域不同的时候。

最常见的情形就是一个函数返回了在其内部定义的嵌套函数。
